<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Chat Anwendung</title>

<style>
  body { font-family: Arial; background:#f0f2f5; margin:0; padding:0; }
  #loginSection, #chatSection { max-width:900px; margin:auto; padding:20px; }
  #loginSection { display:flex; flex-direction:column; align-items:center; height:100vh; justify-content:center; }
  input, textarea { width:100%; padding:10px; margin:5px 0; border-radius:5px; border:1px solid #ccc; }
  button { padding:10px 15px; border:none; border-radius:5px; cursor:pointer; background:#4caf50; color:white; }
  button:hover { background:#45a049; }
  .chat-room { background:white; padding:15px; border-radius:8px; margin-top:20px; }
  .messages { height:250px; overflow-y:auto; padding:10px; background:#f9f9f9; border-radius:5px; border:1px solid #ddd; }
  .message-input { display:flex; gap:10px; margin-top:10px; }
  #privateChatList .chat-room { margin-top:10px; }
</style>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>

<!-- LOGIN -->
<div id="loginSection">
  <h2>Login</h2>
  <input id="username" placeholder="Benutzername">
  <input id="password" type="password" placeholder="Passwort">
  <button id="loginBtn">Login</button>
  <p id="loginError" style="color:red"></p>
</div>

<!-- CHAT -->
<div id="chatSection" style="display:none;">
  <h2>Chat Anwendung</h2>
  <button id="logoutBtn">Logout</button>

  <!-- INFO CHAT -->
  <div class="chat-room">
    <h3>Info-Chat</h3>
    <div class="messages" id="infoMessages"></div>
    <div class="message-input">
      <textarea id="infoInput" placeholder="Nur Admin darf schreiben"></textarea>
      <button id="infoSend">Senden</button>
    </div>
  </div>

  <!-- FRAGEN CHAT -->
  <div class="chat-room">
    <h3>Fragen-Chat</h3>
    <div class="messages" id="fragenMessages"></div>
    <div class="message-input">
      <textarea id="fragenInput" placeholder="Nachricht schreiben..."></textarea>
      <button id="fragenSend">Senden</button>
    </div>
  </div>

  <!-- PRIVATE CHATS -->
  <h3>Private Chats</h3>
  <div id="privateChatList"></div>
</div>

<script>
const SUPABASE_URL = "DEINE_URL_HIER";
const SUPABASE_KEY = "DEIN_ANON_KEY_HIER";

const client = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

let currentUser = null;

/* -------------------- LOGIN -------------------- */
document.getElementById("loginBtn").onclick = async () => {
  const username = document.getElementById("username").value;
  const password = document.getElementById("password").value;

  const { data, error } = await client
    .from("users")
    .select("*")
    .eq("username", username)
    .eq("password_hash", password)
    .single();

  if (!data) {
    document.getElementById("loginError").textContent = "Login fehlgeschlagen!";
    return;
  }

  currentUser = data;

  document.getElementById("loginSection").style.display = "none";
  document.getElementById("chatSection").style.display = "block";

  initChats();
};

/* -------------------- LOGOUT -------------------- */
document.getElementById("logoutBtn").onclick = () => location.reload();


/* -------------------- CHAT SYSTEM -------------------- */

async function initChats() {
  loadMessages(1, "infoMessages");
  loadMessages(2, "fragenMessages");

  subscribeRealtime(1, "infoMessages");
  subscribeRealtime(2, "fragenMessages");

  loadPrivateChats();

  if (!currentUser.is_admin) {
    document.getElementById("infoInput").disabled = true;
    document.getElementById("infoSend").disabled = true;
  }

  document.getElementById("infoSend").onclick = () => sendMessage(1, "infoInput");
  document.getElementById("fragenSend").onclick = () => sendMessage(2, "fragenInput");
}


/* ----- Nachrichten laden ----- */
async function loadMessages(chatId, containerId) {
  const { data } = await client
    .from("messages")
    .select("content, created_at, user:users(username)")
    .eq("chat_id", chatId)
    .order("created_at");

  const box = document.getElementById(containerId);
  box.innerHTML = "";
  data?.forEach(m => {
    box.innerHTML += `<p><b>${m.user.username}</b>: ${m.content}</p>`;
  });

  box.scrollTop = box.scrollHeight;
}


/* ----- Nachricht senden ----- */
async function sendMessage(chatId, inputId) {
  const text = document.getElementById(inputId).value;
  if (!text) return;

  await client.from("messages").insert({
    chat_id: chatId,
    user_id: currentUser.id,
    content: text
  });

  document.getElementById(inputId).value = "";
}


/* ----- Realtime Chat ----- */
function subscribeRealtime(chatId, containerId) {
  client
    .channel("chat_" + chatId)
    .on(
      "postgres_changes",
      { event: "INSERT", schema: "public", table: "messages", filter: `chat_id=eq.${chatId}` },
      payload => loadMessages(chatId, containerId)
    )
    .subscribe();
}


/* -------------------- PRIVATE CHATS -------------------- */
async function loadPrivateChats() {
  const { data } = await client
    .from("members")
    .select("chat_id, chats(name)")
    .eq("user_id", currentUser.id)
    .neq("chat_id", 1)     // nicht Info
    .neq("chat_id", 2);    // nicht Fragen

  const list = document.getElementById("privateChatList");
  list.innerHTML = "";

  for (const chat of data) {
    const div = document.createElement("div");
    div.className = "chat-room";

    div.innerHTML = `
      <h4>${chat.chats.name}</h4>
      <div class="messages" id="private_${chat.chat_id}"></div>
      <div class="message-input">
        <textarea id="input_${chat.chat_id}"></textarea>
        <button onclick="sendPrivate(${chat.chat_id})">Senden</button>
      </div>
    `;

    list.appendChild(div);

    loadPrivateMessages(chat.chat_id);
    subscribeRealtime(chat.chat_id, "private_" + chat.chat_id);
  }
}

async function loadPrivateMessages(chatId) {
  const { data } = await client
    .from("messages")
    .select("content, user:users(username)")
    .eq("chat_id", chatId)
    .order("created_at");

  const box = document.getElementById("private_" + chatId);
  box.innerHTML = "";
  data?.forEach(m => box.innerHTML += `<p><b>${m.user.username}</b>: ${m.content}</p>`);
}

async function sendPrivate(chatId) {
  const input = document.getElementById("input_" + chatId);
  const text = input.value;

  if (!text) return;

  await client.from("messages").insert({
    chat_id: chatId,
    user_id: currentUser.id,
    content: text
  });

  input.value = "";
}
</script>

</body>
</html>
