<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8" />
<title>Chatforum mit CSV</title>
<style>
  body {
    font-family: Arial, sans-serif;
    max-width: 600px;
    margin: 20px auto;
    background: #f9f9f9;
  }
  h2 {
    text-align: center;
  }
  #chat {
    border: 1px solid #ccc;
    background: white;
    height: 300px;
    padding: 10px;
    overflow-y: auto;
    margin-bottom: 15px;
  }
  .nachricht {
    margin-bottom: 10px;
  }
  .nutzer {
    font-weight: bold;
    color: #2a7ae2;
  }
  form {
    display: flex;
    flex-direction: column;
  }
  input, textarea {
    padding: 8px;
    font-size: 1em;
    margin-bottom: 10px;
    border: 1px solid #ccc;
    border-radius: 4px;
    resize: none;
  }
  button {
    padding: 10px;
    font-size: 1em;
    background: #2a7ae2;
    color: white;
    border: none;
    border-radius: 4px;
    cursor: pointer;
  }
  button:hover {
    background: #1a5ec8;
  }
</style>
</head>
<body>

<h2>Chatforum</h2>

<div id="chat"></div>

<form id="chatForm">
  <input type="text" id="nutzer" placeholder="Dein Name" required />
  <textarea id="nachricht" placeholder="Deine Nachricht" rows="3" required></textarea>
  <button type="submit">Senden</button>
</form>

<script>
  const chatDiv = document.getElementById('chat');
  const form = document.getElementById('chatForm');
  const inputNutzer = document.getElementById('nutzer');
  const inputNachricht = document.getElementById('nachricht');

  // Funktion um Nachrichten im Chat anzuzeigen
  function zeigeNachrichten(nachrichten) {
    chatDiv.innerHTML = '';
    nachrichten.forEach(({nutzer, nachricht}) => {
      const div = document.createElement('div');
      div.classList.add('nachricht');
      div.innerHTML = `<span class="nutzer">${nutzer}:</span> ${nachricht}`;
      chatDiv.appendChild(div);
    });
    chatDiv.scrollTop = chatDiv.scrollHeight;
  }

  // Lade alle Nachrichten beim Seitenstart
  async function ladeNachrichten() {
    try {
      const res = await fetch('/nachrichten');
      if (!res.ok) throw new Error('Fehler beim Laden der Nachrichten');
      const daten = await res.json();
      zeigeNachrichten(daten);
    } catch (e) {
      console.error(e);
      chatDiv.innerHTML = '<i>Fehler beim Laden der Nachrichten</i>';
    }
  }

  // Wenn das Formular abgeschickt wird
  form.addEventListener('submit', async (e) => {
    e.preventDefault();
    const nutzer = inputNutzer.value.trim();
    const nachricht = inputNachricht.value.trim();
    if (!nutzer || !nachricht) return;

    // Nachricht an Backend schicken
    try {
      const res = await fetch('/nachricht', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({nutzer, nachricht})
      });
      if (!res.ok) throw new Error('Fehler beim Senden');
      // Nachricht hinzuf√ºgen & Chat aktualisieren
      await ladeNachrichten();
      form.reset();
      inputNutzer.focus();
    } catch (e) {
      alert('Fehler beim Senden der Nachricht');
      console.error(e);
    }
  });

  // Beim Laden Chat initialisieren
  ladeNachrichten();
</script>

</body>
</html>
